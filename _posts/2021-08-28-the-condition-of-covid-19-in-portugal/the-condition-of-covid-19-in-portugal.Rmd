---
title: "The COVID-19 in Portugal"
description: |
  A brief summary of the COVID-19 situation in Portugal.
author:
  - name: Xinying Xu
    url: https://example.com/norajones
date: 08-28-2021
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      error = FALSE, 
                      message = FALSE, 
                      warning = FALSE,
                      options("scipen"=100, "digits"=4))
```

```{r}
library(tidyverse)
library(tsibble)
library(lubridate)
library(DT)
library(plotly)
#remotes::install_github("joachim-gassen/tidycovid19")
library(tidycovid19)
library(viridis)
```

# Data description

The dataset contains the variables about the accumulated confirmed amount, accumulated recovered amount amount and accumulated dead amount, from the beginning of the outbreak to the present. You can find the data from the github of [JOHNS HOPKINS](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series), which supports the worldwide data of COVID-19, in this blog, I only analyse Portugal. And after wangling data, I use `tsibble::difference` to add some variables holds in information of the new daily cases: new confirmed, new recovered and new dead amount. 

Besides, the `tidycovid19` package can be found in [joachim-gassen's github](https://github.com/joachim-gassen/tidycovid19), and while the combined data frame generated by `download_merged_data()` aggregates data at the country-day level, some functions also provide sub-country level data on request.

The vaccine data is downloaded from [European Centre for Disease Prevention and Control (ECDC)](https://www.ecdc.europa.eu/en/covid-19/vaccine-roll-out-overview), which covers in adults (aged 18 years and above) across EU/EEA countries. The variables include: total doses received, number of first doses administered, number of second doses administered and number of administered doses classified as ‘unspecified’.

The table below records the cases which related the COVID-19, it's designed to explore data by yourself. Let's try!



```{r}
# get the COVID-19 data in Portugal.
pt_comfirmed <- read_csv(here::here("data/confirmed_global.csv")) %>% 
  rename( Country = "Country/Region") %>% 
  filter(Country == "Portugal") %>%
  select(-`Province/State`) %>% 
  pivot_longer(cols = c(-Country:-Long),
               names_to = "Date",
               values_to = "Accumulated_comfirmed")
```

```{r}
pt_recovered <- read_csv(here::here("data/recovered_global.csv")) %>% 
  rename( Country = "Country/Region") %>% 
  filter(Country == "Portugal") %>%
  select(-`Province/State`) %>% 
  pivot_longer(cols = c(-Country:-Long),
               names_to = "Date",
               values_to = "Accumulated_recovered")
```

```{r}
pt_dead <- read_csv(here::here("data/deaths_global.csv")) %>% 
  rename( Country = "Country/Region") %>% 
  filter(Country == "Portugal") %>%
  select(-`Province/State`) %>% 
  pivot_longer(cols = c(-Country:-Long),
               names_to = "Date",
               values_to = "Accumulated_dead")
```

```{r}
# combine them together
combined_pt <- pt_comfirmed %>% 
  full_join(pt_recovered, by = c("Country", "Lat","Long","Date")) %>% 
  full_join(pt_dead, by = c("Country", "Lat","Long","Date")) %>%
  select(-Country: -Long) %>% 
  mutate(New_confirmed = difference(Accumulated_comfirmed, default = 0),
         New_recovered = difference(Accumulated_recovered, default = 0),
         New_dead = difference(Accumulated_dead, default = 0)) %>% 
  mutate(Date = mdy(Date),
         Date = as.Date(Date,format = "%Y-%m-%d"))
```

```{r}
datatable(combined_pt, 
          filter = "top",
          rownames = FALSE,
          class="stripe hover",
          extensions = 'Buttons', 
          options = list(pageLength = 5,
                         initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#F0E5CF',
                            'color': '#000'});","}"),
                         dom = 'Bfrtip', buttons = c('csv', 'excel', 'pdf')),
          colnames = c("Date",
                      "Comfirmed",
                      "Recoverd", 
                      "Dead",
                      "New Comfirmed",
                      "New Recovered",
                      "New Dead"),
    caption = "Table1: The overall COVID-19 data in Portugal")

```

# Exploratory data analysis

### The map about the spread of the virus across the Europe

Let's have a quick look at the map, it's the situation about average over 7 days, most area experience about 1000 new confirmed cases, which is not a good signal. while situation in the middle of Europe is much more better, about 200 cases in the past 7 days.

```{r}
merged <- download_merged_data(cached = TRUE, silent = TRUE)
map_covid19(merged, type = "confirmed", region = "Europe")

```

### The total of COVID-19 cases in Portugal

It can seen directly from the plot, although there are still confirmed cases everyday, corresponding with a high recovery rate, which must be related with popularization of vaccines. In addition, we might occur some outliers, the value of the new confirmed variable suddenly be zero after 4th August, it doesn't make sense that recovery rate is zero, just ignore this issue. 

In addition, there's a big gap since 20th May 2020, the new recovery rate dropped to 0, but after that, it rose slowly back to normal. At the beginning of this year, death rate increased at a peak, but soon afterwards the disease slowed down until now.

```{r}
pt_plot <- combined_pt %>%
  select(-Accumulated_comfirmed, -Accumulated_recovered, -Accumulated_dead) %>% 
  mutate(Year = year(Date),
         Month = month(Date),
         Day = day(Date))
```

```{r}
plot1 <- ggplot(pt_plot) +
  geom_line(aes(x = Date, y = log(New_confirmed)),
            color = "#84142D", 
            alpha = 0.8, 
            size = .5)+
  geom_line(aes(x = Date, y = log(New_recovered)),
            color = "#FEA82F", 
            alpha = 0.8,
            size = .5)+
  geom_col(aes(x = Date, y = log(New_dead)),
           fill = "#F0E5CF",
           bin = 50, )+
  theme_bw()+
  ylab("Amount")+
  labs(title = "The trend of COVID-19 in Portugal.")

ggplotly(plot1)
```


### The popularitation of COVID-19 vaccine in Portugal

This plot below shows data reported at national level. It can be seen that the group which are above 60 years old, are more willing to get vaccinated, the vaccination completion rate is higher than other group. However, the young group which age range is 18 to 24, only 39.5% of them have completed the vaccination. The elders believe on the vaccine effectiveness. In order to easy to explore, I adjust the unit of probability to 1000%.

```{r}
vaccine_pt <- read_csv(here::here("data/vaccine_2021_eu.csv")) %>% 
  rename(Country = "ReportingCountry",
         SecondDose = `Second dose`,
         GroupPopulation = `Group population`) %>%
  filter(Country == "Portugal",
         Group != 'ALL',
         Group != "1_Age<60",
         Group != "1_Age60+",
         !is.na(GroupPopulation)) %>%
  group_by(Group, GroupPopulation) %>% 
  summarise(complete_vac = sum(SecondDose)) %>% 
  mutate(vacc_done_prop = complete_vac/GroupPopulation*1000)

```


```{r}
plot2 <-ggplot(vaccine_pt)+
  geom_col(aes(x = Group, 
                    y = vacc_done_prop,
                    group = Group,
                    fill = Group),
               alpha = .6)+
  theme_bw()+
  geom_hline(yintercept = 800, color = "red")+
  scale_fill_brewer(palette ="OrRd")+
  ylab("Daily condition of vaccination")+
  labs(title = "The plot of vaccination of all kinds of groups in Portugal",
      subtitle = "1000%")
ggplotly(plot2)
```


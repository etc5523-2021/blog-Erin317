---
title: "The COVID-19 in Portugal"
author:
  - name: Xinying Xu
    url: https://github.com/etc5523-2021/blog-Erin317
date: 08-28-2021
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      error = FALSE, 
                      message = FALSE, 
                      warning = FALSE,
                      options("scipen"=100, "digits"=4))
```

```{css}
d-article figure tr:hover {background-color: #D7E9F7;}
.d-title{
  background-image: url(https://ychef.files.bbci.co.uk/1600x900/p016dc49.webp);
  width: 100%;
  height: 300px;
}
d-title h1{
  color: white;
}
```

```{r}
library(tidyverse)
library(tsibble)
library(lubridate)
library(DT)
library(plotly)
#remotes::install_github("joachim-gassen/tidycovid19")
library(tidycovid19)
library(sparkline)
library(dygraphs)
library(xts)
```

# Introduction 

Since December 2019,the outbreak began. Since that, the disease has spread worldwide, leading to ongoing pandemic. Millions died, but we're still not sure what caused it yet. This blog has collected the newest data for readers to explore, and we meanly focus the COVID-19 situation in Portugal, which located on the Iberian Peninsula, in south-western Europe. 

![](https://www.theregreview.org/wp-content/uploads/2020/07/GettyImages-178890724-e1593602490899.jpg)
I remember, the first time I heard about Portugal is because of association football, the most popular sport in Portugal. On 26 May 2010, Portugal attained the third place in the FIFA World Ranking, their highest ever, and In recent years, Portugal has consistently maintained a top 10 and, sometimes, a top 5 FIFA world rank position. Speaking of football, I bet, nobody wouldn't like Cristiano Ronaldo, which is a Portuguese professional footballer, his spirit and ambition were as high as ever, as he strives to break records and conquer the world, that really impress me a lot. I admit that Ronaldo is the most important reason why I am interested to analyse the COVID-19 in Portugal.


# Data description

The dataset contains the variables about the accumulated confirmed amount, accumulated recovered amount amount and accumulated dead amount, from the beginning of the outbreak to the present. You can find the data from the github of [JOHNS HOPKINS](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series), which supports the worldwide data of COVID-19, in this blog, I only analyse Portugal. And after wangling data, I use `tsibble::difference` to add some variables holds in information of the new daily cases: new confirmed, new recovered and new dead amount. 

Besides, the `tidycovid19` package can be found in [joachim-gassen's github](https://github.com/joachim-gassen/tidycovid19), and while the combined data frame generated by `download_merged_data()` aggregates data at the country-day level, some functions also provide sub-country level data on request.

The vaccine data is downloaded from [European Centre for Disease Prevention and Control (ECDC)](https://www.ecdc.europa.eu/en/covid-19/vaccine-roll-out-overview), which covers in adults (aged 18 years and above) across EU/EEA countries. The variables include: total doses received, number of first doses administered, number of second doses administered and number of administered doses classified as ‘unspecified’.


```{r}
# get the COVID-19 data in Portugal.
pt_confirmed <- read_csv(here::here("data/confirmed_global.csv")) %>% 
  rename(Country = "Country/Region") %>% 
  filter(Country == "Portugal") %>%
  select(-`Province/State`) %>% 
  pivot_longer(cols = c(-Country:-Long),
               names_to = "Date",
               values_to = "Accumulated_confirmed")
```

```{r}
pt_recovered <- read_csv(here::here("data/recovered_global.csv")) %>% 
  rename( Country = "Country/Region") %>% 
  filter(Country == "Portugal") %>%
  select(-`Province/State`) %>% 
  pivot_longer(cols = c(-Country:-Long),
               names_to = "Date",
               values_to = "Accumulated_recovered")
```

```{r}
pt_dead <- read_csv(here::here("data/deaths_global.csv")) %>% 
  rename( Country = "Country/Region") %>% 
  filter(Country == "Portugal") %>%
  select(-`Province/State`) %>% 
  pivot_longer(cols = c(-Country:-Long),
               names_to = "Date",
               values_to = "Accumulated_dead")
```

```{r}
# combine them together
combined_pt <- pt_confirmed %>% 
  full_join(pt_recovered, by = c("Country", "Lat","Long","Date")) %>% 
  full_join(pt_dead, by = c("Country", "Lat","Long","Date")) %>%
  select(-Country: -Long) %>% 
  mutate("New confirmed" = difference(Accumulated_confirmed, default = 0),
         "New recovered" = difference(Accumulated_recovered, default = 0),
         "New dead" = difference(Accumulated_dead, default = 0)) %>% 
  rename("Accumulated confirmed" = Accumulated_confirmed,
         "Accumulated recovered" = Accumulated_recovered,
         "Accumulated dead" = Accumulated_dead) %>% 
  filter(`New recovered` >= 0) %>% 
  mutate(Date = mdy(Date),
         Date = as.Date(Date,format = "%Y-%m-%d"))
```

```{r}
trend <-combined_pt %>% 
  mutate(year = year(Date),
         month = month(Date))
trend$Date <- with(trend, sprintf("%d-%02d", year, month))
trend <- trend %>% 
  select(Date,`New confirmed`,`New recovered`,`New dead`) %>% 
  group_by(Date) %>% 
  summarise(`New confirmed` = spk_chr(`New confirmed`, type = "line"),
            `New recovered` = spk_chr(`New recovered`, type = "line"),
            `New dead` = spk_chr(`New dead`, type = "line"))
```

The table below records the cases which related the COVID-19,  the trend illustrates the cases trend from `r min(combined_pt$Date)` to `r max(combined_pt$Date)`. And since there are missing value in `Accumulated recovered`, so the newest data shows that accumulated recovered data is 0, which is not reliable, just ignore it, we only focus on the new cases trend. Besides, it's designed to explore data by yourself. Let's try!

```{r}
dtable <- trend %>% 
   datatable(escape = FALSE,
            rownames = FALSE,
          class="stripe hover",
          extensions = 'Buttons', 
          options = list(
                         initComplete = JS(
                            "function(settings, json) {",
                            "$(this.api().table().header()).css({'background-color': '#D7E9F7',
                            'color': '#2B2B2B'});","}"),
                         dom = 'Bfrtip', buttons = c('csv', 'excel', 'pdf'),
                         fnDrawCallback = htmlwidgets::JS('function(){
                                                              HTMLWidgets.staticRender();
                                                              }')),
            colnames = c("Date", "New confirmed", "New recovered", "New dead"),
           caption = "Table1: The trend of new cases since 2020-01-22 to 2021-08-27") %>% spk_add_deps()
dtable
```

# Exploratory data analysis

### The map about the spread of the virus across the Europe

Let's have a quick look at the map, it's the situation about average over 7 days, most area experience about 1000 new confirmed cases, which is not a good signal. while situation in the middle of Europe is much more better, about 200 cases in the past 7 days.

```{r}
merged <- download_merged_data(cached = TRUE, silent = TRUE)
map_covid19(merged, type = "confirmed", region = "Europe")

```

### The total of COVID-19 cases in Portugal

It can seen directly from the plot, although there are still confirmed cases everyday, corresponding with a high recovery rate, which must be related with popularization of vaccines. In addition, we might occur missing value, the value of the new confirmed variable suddenly missed since 4th Aug, that will result in errors when calculating.

 At the beginning of this year, death rate increased at a peak, but soon afterwards the disease slowed down until now, and it seems to that there were two outbreaks in Portugal.

```{r}
pt_plot <- combined_pt %>% 
  select(-`Accumulated confirmed`, -`Accumulated recovered`, -`Accumulated dead`) %>% 
  filter(`New confirmed` >= 0 & `New recovered` >=0 & `New dead` >= 0)
```

```{r}
don=xts( x=pt_plot[,-1], order.by=pt_plot$Date)
dygraph(don, main = "The new cases trend of COVID-19 in Portugal") %>%
  dyRangeSelector(height = 20) %>% 
  dySeries("New confirmed", color = "#84142D") %>% 
  dySeries("New recovered", color = "#FEA82F") %>% 
  dySeries("New dead",color = "#7F7C82") %>% 
  dyOptions(fillGraph = TRUE) %>% 
  dyHighlight(highlightCircleSize = 3, 
              highlightSeriesBackgroundAlpha = 0.6,
              hideOnMouseOut = FALSE)
```


### The popularitation of COVID-19 vaccine in Portugal

This plot below shows data reported at national level. It can be seen that the group which are above 60 years old, are more willing to get vaccinated, the vaccination completion rate is higher than other group. However, the young group which age range is 18 to 24, only 39.5% of them have completed the vaccination. The elders believe on the vaccine effectiveness. In order to easy to explore, I adjust the unit of probability to 100%.

```{r}
vaccine_pt <- read_csv(here::here("data/vaccine_2021_eu.csv")) %>% 
  rename(Country = "ReportingCountry",
         SecondDose = `Second dose`,
         GroupPopulation = `Group population`) %>%
  filter(Country == "Portugal",
         Group != 'ALL',
         Group != "1_Age<60",
         Group != "1_Age60+",
         !is.na(GroupPopulation)) %>%
  group_by(Group, GroupPopulation) %>% 
  mutate(second_done_prop = SecondDose/GroupPopulation*100)

```


```{r}
plot2 <-ggplot(vaccine_pt)+
  geom_boxplot(aes(x = Group, 
                    y = second_done_prop,
                    group = Group,
                    fill = Group),
               alpha = .6)+
  theme_bw()+
  geom_hline(yintercept = 10, color = "red")+
  scale_fill_brewer(palette ="OrRd")+
  xlab("")+
  ylab("Daily condition of vaccination")+
  labs(title = "The plot of vaccination of all kinds of groups in Portugal",
      subtitle = "1000%")+
  coord_flip()

ggplotly(plot2)
```

# Numerical summary

```{r}
summary_pt <- read_csv(here::here("data/vaccine_2021_eu.csv")) %>% 
  rename(Country = "ReportingCountry",
         SecondDose = `Second dose`,
         GroupPopulation = `Group population`) %>%
  filter(Country == "Portugal")
```


```{r}
summary1 <- combined_pt %>%
  filter(Date == "2021-08-27") %>%
  mutate("Death rate" = `Accumulated dead` / `Accumulated confirmed`*100,
         "Confirmed rate" = `Accumulated confirmed` / 8578859 *100,
         "Recovery rate" = 912620 / `Accumulated confirmed`*100) %>% 
  select(Date,`Accumulated confirmed`, `Accumulated dead`, `Death rate`, `Confirmed rate`,`Recovery rate`)
```

```{r}
summary1_mean <- combined_pt %>% 
  filter(`New recovered` >= 0) %>% 
  mutate(mean_new_confirmed = mean(`New confirmed`, na.rm = TRUE),
         mean_new_dead = mean(`New dead`,na.rm = TRUE),
         mean_new_recovery = mean(`New recovered`,na.rm = TRUE)) %>% 
  select(mean_new_confirmed, mean_new_dead, mean_new_recovery) %>% 
  unique()
```


```{r}
summary2 <- summary_pt %>% 
  filter(Group == 'ALL') %>% 
  mutate(total_complete_Dose = sum(SecondDose),
         total_first_Dose = sum(`First dose`),
         dosefirst_comp_rate = total_first_Dose/GroupPopulation*100,
         dose_comp_rate = total_complete_Dose/GroupPopulation*100) %>% 
  filter(Week == '2021-33') %>% 
  select(dosefirst_comp_rate, dose_comp_rate) %>% 
  unique() %>% 
  pivot_longer(cols = c(dosefirst_comp_rate:dose_comp_rate),
               names_to = "Issue",
               values_to = "Value")
```

```{r}
summary3 <- vaccine_pt %>% 
  mutate(total_seconddose = sum(SecondDose)) %>% 
  group_by(Group) %>% 
  summarise(vac_coverage = total_seconddose/GroupPopulation*100) %>% 
  unique()
```

```{r}
summary4 <- merged %>% 
  filter(country == "Portugal") %>% 
  mutate(total_hosp_patient = sum(!is.na(hosp_patients)),
         total_icu_patient  = sum(!is.na(icu_patients)),
         lockdown_length = sum(lockdown)) %>% 
  filter(date == "2021-08-27") %>% 
  select(total_hosp_patient, total_icu_patient, lockdown_length)
```

<figure>
  <figcaption>
    <strong id="pt-caption">Table2: Summary of COVID-19 cases in Portugal</strong><br>
    <span id="pt-summary">The average of new daily dead is not high in recent days.</span>
  </figcaption>
  <table aria-labelledby="pt-caption" aria-describedby="pt-summary">
   <tr>
    <th>Date</th>
    <th>Issue</th>
    <th>Total</th>
    <th>Mean (new cases/day)</th>
  </tr>
  <tr>
    <td>2021-08-27</td>
    <td>Accumulated comfirmed</td>
    <td>1030,791</td>
    <td style="text-align:right;">1,764</td>
  </tr>
  <tr>
    <td>2021-08-27</td>
    <td>Accumulated recovery</td>
    <td>912,620</td>
    <td style="text-align:right;">1,565</td>
  </tr>
  <tr>
    <td>2021-08-27</td>
    <td>Accumulated dead</td>
    <td>17,703</td>
    <td style="text-align:right;">30</td>
  </tr>
  </table>
</figure>
  
  
<figure>
  <figcaption>
    <strong id="pt-caption">Table3: Summary of COVID-19 cases probability in Portugal</strong><br>
    <span id="pt-summary">The recovery rate is pretty high which is a good signal.</span>
  </figcaption>
  <table aria-labelledby="pt-caption" aria-describedby="pt-summary">
  <tr>
    <th>Date<br><br></th>
    <th>Issue<br><br></th>
    <th>Value<br>(%)</th>
  </tr>
  <tr>
    <td>2021-08-27</td>
    <td>Comfirmed rate</td>
    <td style="text-align:right;"> 12.02</td>
  </tr>
   <tr>
    <td>2021-08-27</td>
    <td>Recovery rate</td>
    <td style="text-align:right;">88.54</td>
  </tr>
  <tr>
    <td>2021-08-27</td>
    <td>Death rate</td>
    <td style="text-align:right;">1.72</td>
  </tr>
  </table>
</figure>


<figure>
  <figcaption>
    <strong id="pt-caption">Table4: Summary of COVID-19 vaccine coverage in all kinds of groups</strong><br>
    <span id="pt-summary">The vaccine coverage is high for the age range is above 50 years old, compared with the young group.</span>
  </figcaption>
  <table aria-labelledby="pt-caption" aria-describedby="pt-summary">
  <tr>
    <th>Group</th>
    <th>Vaccine coverage (%)</th>
  </tr>
  <tr style="text-align:right;">
    <td>Age18_24</td>
    <td>39.51</td>
  </tr>
   <tr style="text-align:right;">
    <td>Age25_49</td>
    <td>73.47</td>
  </tr>
  <tr style="text-align:right;">
    <td>Age50_59</td>
    <td>90.25</td>
  </tr>
  <tr style="text-align:right;">
    <td>Age60-69</td>
    <td>95.01</td>
  </tr>
   <tr style="text-align:right;">
    <td>Age70_79</td>
    <td>100.00</td>
  </tr>
   <tr style="text-align:right;">
    <td style="text-align:left;">Age80+</td>
    <td>97.66</td>
  </tr>
  </table>
</figure>

<figure>
  <figcaption>
    <strong id="pt-caption">Table5: Summary of COVID-19 effects in Portugal.</strong><br>
    <span id="pt-summary">Based on 2 aspects: All of the patients who in the hospital are ill critically.</span>
  </figcaption>
  <table aria-labelledby="pt-caption" aria-describedby="pt-summary">
  <tr>
    <th>Issue</th>
    <th>Value</th>
  </tr>
  <tr>
    <td>Total hospital patients</td>
    <td style="text-align:right;">544</td>
  </tr>
   <tr>
    <td>Total ICU patients</td>
    <td style="text-align:right;">544</td>
  </tr>
  <tr>
    <td>Length of lockdown</td>
    <td style="text-align:right;">314</td>
  </tr>
  </table>
</figure>


According to these numerical statistical tables, we can know that:

* The recovery rate is pretty high, about `r round(summary1$"Recovery rate",2)`%, and death rate is `r round(summary1$"Death rate",2)`%, which is a good news, the COVID-19 is fairly under control in Portugal. What's more, Portugal is often portrayed as a relatively successful case in the control of COVID-19's March 2020 outbreak in Europe due to timely confinement measures, commonly referred to as the lockdown.

* There are some reasons for the vaccine coverage of the young is low. The total population of age below 18 years old is unknown, so we cannot calculate the coverage, but research shows that cases of COVID-19 in younger children do not appear to cause onward transmission as often as cases in older children and adults. Children aged between one and 18 years of age have much lower rates of hospitalisation and severe disease requiring intensive hospital care than other age groups.

* The age range from 50 to above 80 groups, are more willing to get vaccinated, the coverage rate is up to about 95%. there's one thing need to emphasize, although the effectiveness of all COVID-19 vaccines authorised in the EU/EEA is very high, no vaccine is 100% effective, when infections do occur, vaccines can prevent severe disease to a large extent, and greatly reduce the number of people in hospital due to COVID-19.

* The total number of patients in ICU is not that much, and it seems that the patients in hospital are severely ill patients. Besides, evidence suggests it is 40% to 60% more transmissible than the earlier Alpha (Β.1.1.7) variant which was the first major variant of concern in the EU. In addition, the Delta variant may be associated with higher risk of hospitalisation.

# Reference

joachim-gassen. tidycovid19 package. https://github.com/joachim-gassen/tidycovid19

JOHNS HOPKINS. CSSEGISandData. COVID-19 times series data (csse_covid_19_time_series)
https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series

European Centre for Disease Prevention and Control (ECDC). https://www.ecdc.europa.eu/en/covid-19/vaccine-roll-out-overview.

Wang E, Cook D, Hyndman RJ (2020). "A new tidy data structure to support exploration and modeling of temporal data." https://doi.org/10.1080/10618600.2019.1695624.

Yihui Xie, Joe Cheng, Xianying Tan. A Wrapper of the JavaScript Library 'DataTables'
https://CRAN.R-project.org/package=DT 

Ramnath Vaidyanathan, Kent Russell and Gareth Watts. sparkline: 'jQuery' Sparkline 'htmlwidget'
 https://CRAN.R-project.org/package=sparkline 

C. Sievert. Interactive Web-Based Data Visualization with R, plotly, and shiny.
  Chapman and Hall/CRC Florida, 2020.
  
Grolemund G, Wickham H (2011). "Dates and Times Made Easy with lubridate." Journal of Statistical Software, 40(3), 1–25. https://www.jstatsoft.org/v40/i03/.

ECDC and EMA update on COVID-19. https://www.ecdc.europa.eu/en/news-events/ecdc-and-ema-update-covid-19

COVID-19 in children and the role of school settings in transmission – second update. https://www.ecdc.europa.eu/en/news-events/covid-19-children-and-role-school-settings-transmission-second-update

On the Progression of COVID-19 in Portugal: A Comparative Analysis of Active Cases Using Non-linear Regression. https://www.frontiersin.org/articles/10.3389/fpubh.2020.00495/full



